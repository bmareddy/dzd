# Goals
The goals of this data model are:
1. Present the following data for use by applications. For each DZD ID -
    * What is the species?
    * What drugs are tested on the species?
    * When did the testing take place?
    * What is the resistance interpretaion?
2. Provide ability for the consumers to define custom resistance interpretation rules
3. Ensure data accuracy and traceability back to Collections and Phenotype datasets
4. Ensure data integrity of certain key fields such as Antibiotic

The data model organizes the data into dimension and fact tables. A fact is each Phenotype observation

# Archive Tables
These tables form the datalake and contain data as received. They establish lineage so all data in other tables can be traced back to a row in these tables. The tables will solve for the fact that different data sets arrive at different time periods.

1. `archive_collections` - Collections data
    * `file_name` - Fully qualified path to the source data file
    * `load_date` - load date
    * __rows as cleaned in the collections file__

2. `archive_phenotype` - Phenotype data
    * `file_name` - Fully qualified path to the source data file
    * `load_date` - load date
    * __rows as present in the Phenotype file__

# Dimension Tables
These act as look up tables to maintain data integrity. Fact table will contain references to these tables as applicable

1. `dim_antibiotics` - Maintains the source of truth for every Antibiotic that appears in the testing data
    * `key` - UUID - Surrogate Key that is generated by etl process for every row
    * `name` - Name as it appears in the Phenotype Data. Unique for every row
    * `clean_name` - Canonical name representing the drug for business use. Human updating is allowed
    * `source_join_key` - Generated through code by processing `name` field to remove case sensitiveness, spaces and certain special characters. Unique for every row. Is used in join conditions
    * `created_at` - Timestamp of when the row was created
    * `updated_at` - Timestamp of when the row was last updated

This same design can be extended for other entities such as Organism, Method, Test etc.. based on their relative importance for business

2. `dim_dzd_interpretation_rules` - Maintains a set of rules for DZD interpretation of susceptibility scores. This is a type 2 dimension where temporalness of the data is preserved since rules may be true only for a period of time
    * `key` - UUID - Surrogate Key that is generated by etl process for every row
    * `valid_from` - Timestamp each row is valid from. Not nullable. Defaults to the date inserted
    * `valid_to` - Timestamp each row is valid until. Nullable. `NULL` indicates this is the current record
    * `organism` - Name of the organism. Not nullable
    * `antibiotic_key` - Antibiotic tested. References `dim_antibiotics.key`
    * `method` - Name of the method. Not nullable
    * `value_lower_bound` - Numeric. can be `NULL`. represents lower bound for the interpretation. `NULL` indicates `<= (upper_bound)` condition
    * `value_upper_bound` - Numeric. can be `NULL`. represents upper bound for the interpretation. `NULL` indicates `>= (lower_bound)` condition
    * `interpretation` - Susceptible/Intermediate/Resistant

The combination of `organism + antibiotic_key + method` unqiuely represents each row in this table for any __given date__

# Fact Table

This is the truth table that accurately represents data contained in the source data.

`fct_phenodata_results` - Each row in the table is unique based on DZD ID, Antibiotic tested and the collection date
* `key` - UUID - Surrogate Key that is generated by etl process for every row
* `etl_date` - Date of ETL. Metadata corresponding to the ETL process
* `etl_runid` - Identifier for a specific run of the ETL pipeline. Metadata
------
* `dzdid` - DZD ID. Not nullable
* `antibiotic_key` - Antibiotic tested. References `dim_antibiotics.key`. Not nullable
* `received_ts` - Timestamp the observation is received at
* `collected_ts` - Timestamp the sample is collected at
* `value` - Value as measured by the test
* `antibiotic_interpretation` - Susceptible/Intermediate/Resistant
* `organism` - Name of the organism represented by the isolate corresponding to the DZD ID
* `method` - Array of methods used for the test
* `test` - Type of test
* `source` - Source of the sample
-------
* `dzd_interpretation` - Nullable. If available, references `dim_dzd_interpretation_rules.interpretation`
* `dzd_interpretation_rule_key` - Nullable. If available, references `dim_dzd_interpretation_rules.key`

# Insights table

This table contains the insights on each drug's susceptibility for each isolate

`insights_phenotype`
* `dzdid` - DZD ID. Not nullable
* `antibiotic_name` - Clean name when available. Otherwise uses name as available in source
* `organism` - Name of the organism
* `interpretation` - Susceptible/Intermediate/Resistant
* `frequency` - Number of times this was tested
* `latest_collection_at` - Timestamp of the most recent collection at

Other derived attributes can be added to the insights table based on business need. Example such as `is_manual_method`, `is_blood_sample` etc..

